//BMP㊣角??????
//???㊣?∼LCD?????????“???辰????,????16????????BMP???? RGB565????.
//㊣?????rgb565?辰?豕??????,?豕?????????????‾??∼?????????????.??????????????????????.
//㊣?????rgb555?????辰?豕??????℅???,???㊣??㊣?????,?迄??㊣?????565??℅??足????∼足﹞“.
//filename:??﹞??﹞??
//x,y:??????????????℅?㊣那  
//mode:????.0,???????“????????﹞???㊣角??;1,???????∼????????,?辰???????∼??????.????????,?辰???“????????.
//﹞?????:0,????;????,?赤?車??.  
u8 bmp_encode(u8 *filename,u16 x,u16 y,u16 width,u16 height,u8 mode)
{				
	FIL* f_bmp;
	u16 bmpheadsize;			//bmp?﹞?車??	   	
 	BITMAPINFO hbmp;			//bmp?﹞	 
	u8 res=0;
	u16 tx,ty;				   	//????????
	u16 *databuf;				//?????????????﹞	   	
	u16 pixcnt;				   	//?????????‾
	u16 bi4width;		       	//????????℅?????	   
	if(width==0||height==0)return PIC_WINDOW_ERR;	//???辰?赤?車
	if((x+width-1)>lcddev.width)return PIC_WINDOW_ERR;		//???辰?赤?車
	if((y+height-1)>lcddev.height)return PIC_WINDOW_ERR;	//???辰?赤?車 
 	 
#if BMP_USE_MALLOC == 1	//????malloc	
	databuf=(u16*)pic_memalloc(1024);		//??㊣?????bi4width?車????℅????????????辰 ,??240?赤????,480??℅?????????.
	if(databuf==NULL)return PIC_MEM_ERR;		//?????那???∫∼?.
	f_bmp=(FIL *)pic_memalloc(sizeof(FIL));	//??㊣?FIL℅????????????辰 
	if(f_bmp==NULL)								//?????那???∫∼?.
	{		 
		pic_memfree(databuf);
		return PIC_MEM_ERR;				
	} 	 
#else
	databuf=(u16*)bmpreadbuf;
	f_bmp=&f_bfile;
#endif	      
	bmpheadsize=sizeof(hbmp);//????bmp?????﹞???車??   
	mymemset((u8*)&hbmp,0,sizeof(hbmp));//???????那??????????.	    
	hbmp.bmiHeader.biSize=sizeof(BITMAPINFOHEADER);//?????﹞?車??
	hbmp.bmiHeader.biWidth=width;	 	//bmp???赤??
	hbmp.bmiHeader.biHeight=height; 	//bmp??????
	hbmp.bmiHeader.biPlanes=1;	 		//????1
	hbmp.bmiHeader.biBitCount=16;	 	//bmp??16????bmp
	hbmp.bmiHeader.biCompression=BI_BITFIELDS;//?????車????㊣????????“?????????“??
 	hbmp.bmiHeader.biSizeImage=hbmp.bmiHeader.biHeight*hbmp.bmiHeader.biWidth*hbmp.bmiHeader.biBitCount/8;//bmp???????車??
 				   
	hbmp.bmfHeader.bfType=((u16)'M'<<8)+'B';//BM????㊣那??
	hbmp.bmfHeader.bfSize=bmpheadsize+hbmp.bmiHeader.biSizeImage;//????bmp???車??
   	hbmp.bmfHeader.bfOffBits=bmpheadsize;//??????????????

	hbmp.RGB_MASK[0]=0X00F800;	 		//?足??????
	hbmp.RGB_MASK[1]=0X0007E0;	 		//????????
	hbmp.RGB_MASK[2]=0X00001F;	 		//????????

	if(mode==1)res=f_open(f_bmp,(const TCHAR*)filename,FA_READ|FA_WRITE);//?????辰?????∼??????
 	if(mode==0||res==0x04)res=f_open(f_bmp,(const TCHAR*)filename,FA_WRITE|FA_CREATE_NEW);//????0,?辰???????辰???∫∼?,?辰???“??????		   
 	if((hbmp.bmiHeader.biWidth*2)%4)//????????(℅???)????4??㊣???
	{
		bi4width=((hbmp.bmiHeader.biWidth*2)/4+1)*4;//?????????????赤??????,㊣?????4??㊣???.	
	}else bi4width=hbmp.bmiHeader.biWidth*2;		//??????4??㊣???	 
 	if(res==FR_OK)//???“????
	{
		res=f_write(f_bmp,(u8*)&hbmp,bmpheadsize,&bw);//????BMP?℅??  
		for(ty=y+height-1;hbmp.bmiHeader.biHeight;ty--)
		{
			pixcnt=0;
 			for(tx=x;pixcnt!=(bi4width/2);)
			{
				if(pixcnt<hbmp.bmiHeader.biWidth)databuf[pixcnt]=LCD_ReadPoint(tx,ty);//????℅?㊣那?????? 
				else databuf[pixcnt]=0Xffff;//????∼℅????????.  
				pixcnt++;
				tx++;
			}
			hbmp.bmiHeader.biHeight--;
			res=f_write(f_bmp,(u8*)databuf,bi4width,&bw);//????????
		}
		f_close(f_bmp);
	}	    
#if BMP_USE_MALLOC == 1	//????malloc	
	pic_memfree(databuf);	 
	pic_memfree(f_bmp);		 
#endif	
	return res;
}