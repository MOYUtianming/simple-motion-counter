课程设计  
吕晖_钱明泽_黄钦 小组  
start date :2019.10.15.Tuesday.    

# 本小组课题 : 简易_康复训练动作_计数器

## 一、   概念层&配套硬件声明
1. 主要功能  
  通过被动型动作捕捉对病人的动作进行识别和计数(可通过按钮设置周期/次数/读取或清理记录);**修改为使用SD卡记录设置数据**  
  拓展1:实现语音辅助的动作纠正;***无法实现拓展三,删除***  
  拓展2:实现异常掉电数据记录;  ***工期不够,删除***  
  拓展3:实现动作捕捉画面显示;  ***硬件缺失,删除***  
2. 硬件配置  
 * 主板   : *STM32F407ZGT6*;
 * 摄像头 : *OV2640*;
 * 存储器 : *TOSHIBA_micro_SD_64GB*;
 * 可选配置  
     {  
         开发板自带MP3模块语音播报;  
         [显示器:ALIENTEK TFTLCD (3.5inch.<对应拓展3>]   ***硬件缺失,删除;***  
     }
3. 开发平台  
    **MDK5**;
4. 示例动作  
   * 右手竖直向上举过头顶并完全伸直;
   * 右手竖直向右挥臂,直至肩肘腕三关节共线并且整只手臂水平于地面;
## 二、   功能层声明
1. 初始化  
每个记录周期开始时,需要要求  
    ***被测者右手***

   * 朝向右侧;
   * 完全伸直;
   * 水平于地面;

    ***此处应有语音提示***;  
1. 动作捕捉  
		开始计数后,对摄像头回传的照片进行分析,找出标记的三个关节所在位置,并记录;  
3. 动作识别  
		利用上述记录进行三关节运动轨迹分析,给出正误判断;  
4. 输出信号  
		如果病人动作符合预设要求,语音提示一个动作完成;  
5. 最终结果  
		一个周期动作完成之后进行语音提示;  
## 三、   算法层需求实现
1. RGB565图片获取函数;  **实现**
2. RGB565图片存取函数;  **实现**
3. RGB565图片位向量标记函数;(三合一)**实现**
4. 运动识别算法  
  1） FSM(include 3 state based on the marks' kinds.  **实现**  
  2） 标准动作一阶中心距轨迹数组;*调参进程*  
  3） 求三类标记一阶中心距函数;*待改进*  
  4） 三类标记轨迹记录函数;  
  5） 单个轨迹分析函数;  
  6） 总体轨迹分析函数;  
5. 语音播报函数;  *等待钱明泽 & 黄钦工作成果*
6. FSM-Pro (which based on those motion capture functions)  
7. 语音播报程序;
4.  系统相关  
	* (略) <系统初始化>  **实现**  
## 四、   日志
- 2019.11.19.Tuesday.
**新增完成内容**
1. recg 函数实现;
   现在可以完成MARK文件的创建了;
2. 基础状态机建立完毕;
3. 确认了图像不需要跳过插入像素;(480 % 4 = 0);  
*下周规划*
1. 完成基于MARK文档的功能函数;
   这包括 :  
   1. 特定像素值快速读取;(基于输入的坐标和状态)
   2. 特定像素值的快速修改;(基于输入的坐标和状态)
2. 基于MARK文档,对core函数作相应特化,生成Score函数;
3. 基于MARK文档,定义TRACK文档;
- 2019.11.12.Tuesday.
**新增删减内容**
1. 删减原因:本组程序员负担不起长时间专门待在D001专门进行调试的时间成本;
2. 删减内容:缺失液晶导致的调试时间成本极大增加,故删减精度相关功能如下:
   {
     1. 删减实时矫正功能;
     2. 删减精细动作识别功能,改为三段采样;
   }
**新增完成内容**
1. 完成bmp文件解构;
   这包括:
   * bitmapfilehead 信息解构;
   * bitmapinfohead 信息解构;
   * mask           信息解构;
   * pixel          信息解构;
- 2019.11.5.Tuesday.  
**新增完成内容**
  1. 完成SDcard<->stm32<->camera硬件通路调试;
  2. 完成标准库stdio.h以及malloc函数的相关实现查找;
     这包括:
     1. FILE类型的实现;(在stm32官方库中称为FIL)
     2. fopen / fclose / fread / fwrite / fseek / feof / ftell;
     3. 官方库自建的fmkdir / fopendir / fclosedir;
  3. 结合1&2,现在可以在windows平台上调试算法并且简便的移植到嵌入式平台了;
  4. 一阶中心距函数实现;
     这代表着识别同色区域灰度质心成为可能;
  5. 读取BMP文件头并了解相关信息;
  6. *下周目标*
     实现图片标记函数mark和图片标记文件*.MARK标准的制定;

- 2019.10.29.Tuesday.  
**本周主要是按照前面的规划完成既定内容**
  1. 学习stm32例程中的蜂鸣器模块;
  2. 学习stm32例程中的GPIO位控制模块;*为了学习基本的引脚控制方法*
  3. 学习stm32例程中的摄像头模块_照相机功能实现;
  4.  学习stm32例程中的音频播放器模块;
  5.  额外1 :硬件冲突问题;
         - 发现摄像头和SD卡只能分时复用的问题;
         - 发现板载音频播放器和摄像头只能分时复用的问题;
  6.  学习stm32例程中的SD卡模块;
  7.  额外2 :以上所有例程都是直接学习的库函数版本,没有调用底层的寄存器;

- 2019.10.23  
**新增完成内容**  
  1. 完成内容:统一跨平台调试环境搭建;  
   - *supplement*: 抛弃MDK5,使用统一的跨平台IDE  
     - STM32CubeIDE;  
  2. 完成内容:硬件调试通路的搭建;  
   - 使用ST-link+openOCD作为接口进行硬件调试;  
   - *supplement*: 使用官方的ST-link硬件需要给板独立供电;
    
     *(淘宝上私人自制的的没有这个问题)*
  3. 问题1:关于流程的设计问题;  
   - 抛弃方案: 直接读取至CPU并进行分析;
     - 原因: 对CPU使用频繁;
   - 抛弃方案: 使用DMA直接存入SD卡之后再采样;
     - 原因: 传输和采样都是占用的SD卡的带宽,没有使用DMA的意义;
   - 现用方案:  实时压缩存储+实时分析;
     - CPU直接读取数据,  
     - 但每读两个字节(RGB565基本像素单元)使用一个字节进行位标记,存在内存中;
     - 标记满一张图就暂停采样,将数据存入SD卡;
     - 每采样两张图就计算一次一阶中心距, 
       并在内存中的轨迹图上更新标记,  
       之后实时通过语音调整被测者姿势;  
       ***(需要考虑采样过快导致的提醒频繁问题)***
     - 每做完一次动作就将轨迹图存入SD卡,  
       判定轨迹图是否符合标准,  
       符合就语音输出  **动作成功**;  
       不符合就语音输出**动作失败,请重新来过**,失败次数加一;  
       之后清空内存中的轨迹图;  
     - 循环**预设次数**+**失败次数**;
     - 当整个循环结束以后,  
       依据**失败次数/成功次数**输出本次循环评价,  
       并将评价存入SD卡;  
       之后语音提示结束本次训练;
     - 当整个周期结束以后,还需要根据多次循环评价给出周期评价;  
    ***至此,上周的最后一个问题"如何将图片存入SD卡"已在概念层解决;***
- 2019.10.16  
**新增完成内容**
  1. 完成内容: 摄像头驱动程序;  
  2. 完成内容: 总体规划;
  3. 问题1: 如何实现图像识别?
  	- 暂定方案: 在被测者手臂上关键关节处(肩肘腕)做有色标记,  
  				摄像头拍摄RGB565图像,直接读取图像数据,  
  				进行位向量标记(各色标记不同),给出三个位向量数组,  
  				最后综合数据进行各关节轨迹分析;  
  4. 问题2: 如何实现计数成功提示?
  	- 抛弃方案:	蜂鸣器; <单调,无法实现正姿功能>
  	- 抛弃方案:	LCD;<板子平放,无法有效提醒>
  	- 抛弃方案:	发光二极管;<单调,无法实现正姿功能>
  	  现用方案:	MP3播放模块;  
  4. 问题3: 如何存储视频流以用于分析?  
  	- 抛弃方案:	EEPROM;<现有模块容量太小,其他模块过于昂贵>
  	
  	- 现用方案:	64GBmicroSD配转TF卡套[适配主板];
  4. 目前问题 : 如何将OV2640拍摄的照片存入SD;


	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	